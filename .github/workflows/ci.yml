name: Python package

on: [push, pull_request]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.6, 3.7, 3.8, 3.9]
        django-version: ['2.2', '3.0', '3.1', '3.2']
        arch: [x64, ppc64le]
        include:
          - python-version: 3.6
            django-version: '2.2'
            arch: x64
          - python-version: 3.7
            django-version: '2.2'
            arch: x64
          - python-version: 3.8
            django-version: '2.2'
            arch: x64
          - python-version: 3.9
            django-version: '2.2'
            arch: x64
          - python-version: 3.6
            django-version: '3.0'
            arch: x64
          - python-version: 3.7
            django-version: '3.0'
            arch: x64
          - python-version: 3.8
            django-version: '3.0'
            arch: x64
          - python-version: 3.9
            django-version: '3.0'
            arch: x64
          - python-version: 3.6
            django-version: '3.1'
            arch: x64
          - python-version: 3.7
            django-version: '3.1'
            arch: x64
          - python-version: 3.8
            django-version: '3.1'
            arch: x64
          - python-version: 3.9
            django-version: '3.1'
            arch: x64
          - python-version: 3.6
            django-version: '3.2'
            arch: x64
          - python-version: 3.7
            django-version: '3.2'
            arch: x64
          - python-version: 3.8
            django-version: '3.2'
            arch: x64
          - python-version: 3.9
            django-version: '3.2'
            arch: x64

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.arch }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tox
    - name: Test with tox
      run: |
        tox
    - name: Send notification
      if: ${{ failure() }}
      uses: dawidd6/action-send-mail@v2
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: Build failure
        body: |
          Build failed for Python ${{ matrix.python-version }} and Django ${{ matrix.django-version }}
        to: niwi@niwi.nz
        from: Github Action
        smtp_ssl: True