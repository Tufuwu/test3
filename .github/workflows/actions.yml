name: CI Pipeline

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: [19.3.5, 18.14.9]
        python: [ "3.9", "3.8"]
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ matrix.python }}-pip
          restore-keys: |
            ${{ matrix.python }}-pip
      - name: Install dependencies
        run: |
          pip install --upgrade pip setuptools
          pip install flake8 flake8-print coveralls
      - name: Before install
        run: |
          if [ ! -z $DOCKER_PASSWORD ]; then echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin; fi
          docker run -d -p 127.0.0.1:9000:9000 -p 127.0.0.1:8123:8123 --name test-clickhouse-server --ulimit nofile=262144:262144 yandex/clickhouse-server:$VERSION
          docker ps -a
          sed -i 's/^host=localhost$/host=clickhouse-server/' setup.cfg
          echo '127.0.0.1 clickhouse-server' | sudo tee /etc/hosts > /dev/null
      - name: Lint
        run: flake8
      - name: Test
        run: coverage run --source=clickhouse_sqlalchemy setup.py test
      - name: Upload coverage
        run: coveralls
        if: success ()