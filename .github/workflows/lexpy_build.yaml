name: Python Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            python-version: 3.6
          - os: ubuntu-latest
            python-version: 3.7
          - os: ubuntu-latest
            python-version: 3.8
          - os: ubuntu-latest
            python-version: 3.9
          - os: ubuntu-latest
            python-version: pypy3
          - os: windows-latest
            python-version: 3.8.0
          - os: windows-latest
            python-version: 3.9.0
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python for Windows
        if: matrix.os == 'windows-latest'
        run: |
          choco install python --version ${{ matrix.python-version }}
          echo "PATH=C:\\Python${{ matrix.python-version:0:3 }}\\;C:\\Python${{ matrix.python-version:0:3 }}\\Scripts\\;%PATH%" >> $GITHUB_ENV

      - name: Set up Python for Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          if [ "${{ matrix.python-version }}" = "pypy3" ]; then
            apt-get update
            apt-get install -y pypy3
          else
            apt-get update
            apt-get install -y python${{ matrix.python-version }} python3-pip
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage coveralls

      - name: Run tests
        run: |
          coverage run -m unittest discover -s lexpy/tests
          coverage report -i -m
          coveralls